<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Infinite Zoom Journey + Audio</title>
<style>
html, body {
  margin: 0;
  overflow: hidden;
  background: black;
  height: 100%;
}
canvas {
  display: block;
  width: 100%;
  height: 100%;
  cursor: grab;
  background: black;
}
#overlay {
  position: absolute;
  top: 5px;
  left: 5px;
  color: white;
  font-family: monospace;
  font-size: 14px;
  background: rgba(0,0,0,0.4);
  padding: 4px 8px;
  border-radius: 4px;
}
#audioSelect {
  position: absolute;
  top: 5px;
  right: 5px;
  z-index: 10;
  font-family: monospace;
  font-size: 14px;
}
h1 {
  color: white;
  text-shadow: 0 0 6px rgba(0,0,0,0.85);
  color: #fff;
  /* multiple shadows around the text to form a more even halo */
  text-shadow:
    0 0 2px rgba(0,0,0,0.9),
    0 0 6px rgba(0,0,0,0.75),
    0 0 10px rgba(0,0,0,0.6);
}
</style>
</head>
<body>
<style type="text/css" media="screen">
h1 {
	font-family: Arial;
	font-size:18px;
}
</style>
<h1 style="position:absolute; top:50px; left:50px; z-index:999; color:white;">
	Hello world!
  <br>
  <ol>
	  <li>Grab your mouse and hit &lt;F11&gt;! Fullscreen. Yeah!</li>
	  <li>Hit the spacebar to stop the video. Audio will begin to play.</li>
	  <li>Hit the spacebar again. Video will begin again to play.</li>
	  <li>Try the '&lt;' and '&gt;' (also up/down arrow) keys to speed up and slow down the audio! Fun eh?</li>
	  <li>Now grab the video with your mouse and speed the video up and down!</li>
	  <li>CHANGE AUDIO top-right: Ambient, Forest & Space. Give it a couple of seconds to load.</li>
  </ol>
</h1>

<canvas id="zoomCanvas"></canvas>
<div id="overlay">Loading...</div>
<select id="audioSelect">
  <option value="ambient.mp3">Ambient</option>
  <option value="forest.mp3">Forest</option>
  <option value="space.mp3">Space</option>
  <option value="sand.mp3">Sand</option>
  <option value="fire.mp3">Fire</option>
</select>

<script>
/* ========== SETTINGS ========== */
const TARGET_ASPECT = 4/3;
const BASE_DRIFT = 0.02;
const SCALE_FACTOR = 1.4;
/* ============================== */

const canvas = document.getElementById("zoomCanvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
let w,h;

function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

let images = [];
let zoom = 0;
let zoomSpeed = 0;
let dragging = false;
let lastY = 0;
let paused = false;
let fitMode = true;
let baseAudioSpeed = 0.79; // adjustable with < >

// Load images from images.txt
// Load images from images.txt SEQUENTIALLY
fetch('images.txt')
  .then(r => r.text())
  .then(async text => {
    const filenames = text.split(/\r?\n/).filter(line => line.trim() !== "");
    if (filenames.length === 0) {
      overlay.textContent = "No images found in images.txt";
      return;
    }

    let loaded = 0;
    for (const src of filenames) {
      await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          loaded++;
          overlay.textContent = `Loaded ${loaded}/${filenames.length}`;
          images.push(img);
          resolve();
        };
        img.onerror = () => {
          console.warn("Failed to load:", src);
          overlay.textContent = `Error loading ${src}`;
          // resolve anyway to keep going
          resolve();
        };
        img.src = src.trim();
      });
    }

    overlay.textContent = "All images loaded â€” Ready!";
    start();
  })
  .catch(err => overlay.textContent = "Failed to load images.txt: " + err);


//
//
//
//
//fetch('images.txt')
  //.then(r => r.text())
  //.then(text => {
    //const filenames = text.split(/\r?\n/).filter(line => line.trim() !== "");
    //if(filenames.length===0) overlay.textContent = "No images found in images.txt";
    //let loaded = 0;
    //filenames.forEach(src=>{
      //const img = new Image();
      //img.src = src;
      //img.onload = ()=>{
        //loaded++;
        //if(loaded === filenames.length) {
          //overlay.textContent = "Ready";
          //start();
        //}
      //};
      //images.push(img);
    //});
  //})
  //.catch(err=> overlay.textContent = "Failed to load images.txt");

canvas.addEventListener("wheel", e=>{
  zoomSpeed += e.deltaY * -0.001;
  e.preventDefault();
});

canvas.addEventListener("mousedown", e=>{
  dragging = true;
  lastY = e.clientY;
  canvas.style.cursor = "grabbing";
});
canvas.addEventListener("mouseup", ()=>{
  dragging = false;
  canvas.style.cursor = "grab";
});
canvas.addEventListener("mousemove", e=>{
  if(dragging){
    let dy = e.clientY - lastY;
    zoomSpeed += dy * -0.01;
    lastY = e.clientY;
  }
});

window.addEventListener("keydown", e=>{
  if(e.code === "ArrowUp") zoomSpeed += 0.1;
  else if(e.code === "ArrowDown") zoomSpeed -= 0.1;
  else if(e.code === "Space") paused = !paused;
  else if(e.code === "KeyF") fitMode = !fitMode;
  else if(e.key === ">") baseAudioSpeed *= 1.05;
  else if(e.key === "<") baseAudioSpeed /= 1.05;
});

/* ===== Web Audio Setup ===== */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let forwardBuffer = null;
let reversedBuffer = null;
let sourceNode = null;
let gainNode = audioCtx.createGain();
gainNode.connect(audioCtx.destination);
let playingReverse = false;
let audioUnlocked = false;

function startAudio(loopBuffer) {
  if (sourceNode) sourceNode.disconnect();
  sourceNode = audioCtx.createBufferSource();
  sourceNode.buffer = loopBuffer;
  sourceNode.loop = true;
  sourceNode.connect(gainNode);
  sourceNode.playbackRate.value = baseAudioSpeed;
  sourceNode.start(0);
}

function loadAudio(src) {
  fetch(src)
    .then(r => r.arrayBuffer())
    .then(b => audioCtx.decodeAudioData(b))
    .then(decoded => {
      forwardBuffer = decoded;
      reversedBuffer = audioCtx.createBuffer(decoded.numberOfChannels, decoded.length, decoded.sampleRate);
      for (let c = 0; c < decoded.numberOfChannels; c++) {
        reversedBuffer.getChannelData(c).set(decoded.getChannelData(c).slice().reverse());
      }
      overlay.textContent = "Audio loaded. Click or press a key to start.";
      if (audioUnlocked) {
        startAudio(forwardBuffer);
      }
    })
    .catch(err => overlay.textContent = "Audio load error: " + err);
}

loadAudio(document.getElementById("audioSelect").value);

document.getElementById("audioSelect").addEventListener("change", e => {
  loadAudio(e.target.value);
});

function unlockAudio() {
  if (audioUnlocked) return;
  audioCtx.resume();
  if (forwardBuffer) startAudio(forwardBuffer);
  audioUnlocked = true;
  overlay.textContent = "Ready";
  window.removeEventListener("keydown", unlockAudio);
  window.removeEventListener("mousedown", unlockAudio);
}
window.addEventListener("keydown", unlockAudio);
window.addEventListener("mousedown", unlockAudio);

function setPlaybackDirection(reverse) {
  if (!forwardBuffer || !reversedBuffer) return;
  if (playingReverse === reverse) return;
  playingReverse = reverse;
  if (sourceNode) sourceNode.disconnect();
  startAudio(reverse ? reversedBuffer : forwardBuffer);
}

/* ===== Main Draw Loop ===== */
function drawImageFitAspect(img){
  const imgAspect = img.width / img.height;
  let drawW, drawH;

  if(fitMode){
    if(imgAspect > TARGET_ASPECT){
      drawH = h;
      drawW = h * TARGET_ASPECT;
    } else {
      drawW = w;
      drawH = w / TARGET_ASPECT;
    }
  } else {
    if(imgAspect > TARGET_ASPECT){
      drawW = w;
      drawH = w / imgAspect;
    } else {
      drawH = h;
      drawW = h * imgAspect;
    }
  }
  ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
}

function drawOverlay(){
  overlay.textContent =
    `${fitMode? "FIT":"FILL"} | drift: ${(BASE_DRIFT+zoomSpeed).toFixed(3)} | ` +
    `audio x${baseAudioSpeed.toFixed(2)} ${playingReverse ? "(rev)" : ""}`;
}

function draw(){
  ctx.clearRect(0,0,w,h);
  if(!paused) zoom += BASE_DRIFT + zoomSpeed;
  zoomSpeed *= 0.9;

  const total = images.length;
  if(total===0) return;

  const zIndex = ((zoom % total)+total)%total;
  const i0 = Math.floor(zIndex);
  const i1 = (i0+1)%total;
  const t = zIndex - i0;

  const img0 = images[i0];
  const img1 = images[i1];

  const scale0 = Math.pow(SCALE_FACTOR, -t);
  const scale1 = Math.pow(SCALE_FACTOR, 1-t);

  ctx.save();
  ctx.translate(w/2,h/2);
  ctx.scale(scale0,scale0);
  ctx.globalAlpha = 1 - t*0.5;
  drawImageFitAspect(img0);
  ctx.restore();

  ctx.save();
  ctx.translate(w/2,h/2);
  ctx.scale(scale1,scale1);
  ctx.globalAlpha = t + 0.3;
  drawImageFitAspect(img1);
  ctx.restore();

  ctx.globalAlpha = 1;
  drawOverlay();

  if (sourceNode) {
    // Update audio speed & direction
    setPlaybackDirection(zoomSpeed < -0.02);
    sourceNode.playbackRate.value = Math.max(0.1, baseAudioSpeed * (1 + zoomSpeed));
  }

  requestAnimationFrame(draw);
}

function start(){
  draw();
}
</script>
</body>
</html>

