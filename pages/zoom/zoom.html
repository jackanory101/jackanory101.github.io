<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Infinite Zoom Journey + Audio</title>
<style>
html, body {
  margin: 0;
  overflow: hidden;
  background: black;
  height: 100%;
}
canvas {
  display: block;
  width: 100%;
  height: 100%;
  cursor: grab;
  background: black;
}
#overlay {
  position: absolute;
  top: 5px;
  left: 5px;
  color: white;
  font-family: monospace;
  font-size: 14px;
  background: rgba(0,0,0,0.4);
  padding: 4px 8px;
  border-radius: 4px;
}
#audioSelect, #fullscreenBtn {
  position: absolute;
  top: 5px;
  right: 5px;
  z-index: 10;
  font-family: monospace;
  font-size: 14px;
}
#fullscreenBtn {
  right: 140px;
  background: rgba(0,0,0,0.5);
  color: white;
  border: 1px solid white;
  border-radius: 4px;
  padding: 2px 6px;
}
h1 {
  position: absolute;
  top: 50px;
  left: 50px;
  z-index: 999;
  color: white;
  font-family: Arial;
  font-size: 18px;
  text-shadow:
    0 0 2px rgba(0,0,0,0.9),
    0 0 6px rgba(0,0,0,0.75),
    0 0 10px rgba(0,0,0,0.6);
}
</style>
</head>
<body>

<h1>
  Hello world!
  <br>
  <ol>
	  <li>Hit fullscreen button at top-right of screen.</li>
	  <li>Hit the spacebar or jab finger on screen to stop video and play audio.</li>
	  <li>Hit spacebar/jab finger again. Video will begin to play.</li>
	  <li>Try the '&lt;' and '&gt;' (also up/down arrow) keys to speed up and slow down the audio! Fun eh?</li>
	  <li>Now grab the video with your mouse/finger and speed the video up and down!</li>
	  <li>CHANGE AUDIO top-right: Ambient, Forest & Space. Give it a couple of seconds to load.</li>
  </ol>
</h1>

<canvas id="zoomCanvas"></canvas>
<div id="overlay">Loading...</div>
<select id="audioSelect">
  <option value="ambient.mp3">Ambient</option>
  <option value="forest.mp3">Forest</option>
  <option value="space.mp3">Space</option>
  <option value="sand.mp3">Sand</option>
  <option value="fire.mp3">Fire</option>
</select>
<button id="fullscreenBtn">Fullscreen</button>

<script>
/* ========== SETTINGS ========== */
const TARGET_ASPECT = 4/3;
const BASE_DRIFT = 0.02;
const SCALE_FACTOR = 1.4;
/* ============================== */

const canvas = document.getElementById("zoomCanvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
let w,h;

function resize() {
  const dpr = window.devicePixelRatio || 1;
  w = canvas.width = window.innerWidth * dpr;
  h = canvas.height = window.innerHeight * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener("resize", resize);
resize();

let images = [];
let zoom = 0;
let zoomSpeed = 0;
let dragging = false;
let lastY = 0;
let paused = false;
let fitMode = true;
let baseAudioSpeed = 0.72;

/* ====== IMAGE LOAD ====== */
fetch('images.txt')
  .then(r => r.text())
  .then(text => {
    const filenames = text.split(/\r?\n/).filter(line => line.trim() !== "");
    if(filenames.length===0) overlay.textContent = "No images found in images.txt";
    let loaded = 0;
    function loadNext(i) {
      if (i >= filenames.length) { overlay.textContent = "Ready"; start(); return; }
      const img = new Image();
      img.onload = () => { images.push(img); loadNext(i+1); };
      img.onerror = () => { console.warn("Image failed:", filenames[i]); loadNext(i+1); };
      img.src = filenames[i];
    }
    loadNext(0);
  })
  .catch(err=> overlay.textContent = "Failed to load images.txt");

/* ====== CONTROLS ====== */
canvas.addEventListener("wheel", e=>{
  zoomSpeed += e.deltaY * -0.001;
  e.preventDefault();
});

canvas.addEventListener("mousedown", e=>{
  dragging = true;
  lastY = e.clientY;
  canvas.style.cursor = "grabbing";
});
canvas.addEventListener("mouseup", ()=>{
  dragging = false;
  canvas.style.cursor = "grab";
});
canvas.addEventListener("mousemove", e=>{
  if(dragging){
    let dy = e.clientY - lastY;
    zoomSpeed += dy * -0.01;
    lastY = e.clientY;
  }
});

// ---- Touch support ----
let touchStartY = 0;
canvas.addEventListener("touchstart", e => {
  dragging = true;
  touchStartY = e.touches[0].clientY;
}, {passive: true});
canvas.addEventListener("touchend", () => { dragging = false; });
canvas.addEventListener("touchmove", e => {
  if (dragging) {
    let dy = e.touches[0].clientY - touchStartY;
    zoomSpeed += dy * -0.01;
    touchStartY = e.touches[0].clientY;
  }
}, {passive: true});

window.addEventListener("keydown", e=>{
  if(e.code === "ArrowUp") zoomSpeed += 0.1;
  else if(e.code === "ArrowDown") zoomSpeed -= 0.1;
  else if(e.code === "Space") paused = !paused;
  else if(e.code === "KeyF") fitMode = !fitMode;
  else if(e.key === ">") baseAudioSpeed *= 1.05;
  else if(e.key === "<") baseAudioSpeed /= 1.05;
});

/* ===== AUDIO ===== */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let forwardBuffer = null;
let reversedBuffer = null;
let sourceNode = null;
let gainNode = audioCtx.createGain();
gainNode.connect(audioCtx.destination);
let playingReverse = false;
let audioUnlocked = false;

function startAudio(loopBuffer) {
  if (sourceNode) sourceNode.disconnect();
  sourceNode = audioCtx.createBufferSource();
  sourceNode.buffer = loopBuffer;
  sourceNode.loop = true;
  sourceNode.connect(gainNode);
  sourceNode.playbackRate.value = baseAudioSpeed;
  sourceNode.start(0);
}

function loadAudio(src) {
  fetch(src)
    .then(r => r.arrayBuffer())
    .then(b => audioCtx.decodeAudioData(b))
    .then(decoded => {
      forwardBuffer = decoded;
      reversedBuffer = audioCtx.createBuffer(decoded.numberOfChannels, decoded.length, decoded.sampleRate);
      for (let c = 0; c < decoded.numberOfChannels; c++) {
        reversedBuffer.getChannelData(c).set(decoded.getChannelData(c).slice().reverse());
      }
      overlay.textContent = "Audio loaded. Tap or press key to start.";
      if (audioUnlocked) startAudio(forwardBuffer);
    })
    .catch(err => overlay.textContent = "Audio load error: " + err);
}
loadAudio(document.getElementById("audioSelect").value);

document.getElementById("audioSelect").addEventListener("change", e => loadAudio(e.target.value));

function unlockAudio() {
  if (audioUnlocked) return;
  audioCtx.resume();
  if (forwardBuffer) startAudio(forwardBuffer);
  audioUnlocked = true;
  overlay.textContent = "Ready";
  window.removeEventListener("keydown", unlockAudio);
  window.removeEventListener("mousedown", unlockAudio);
  window.removeEventListener("touchstart", unlockAudio);
}
window.addEventListener("keydown", unlockAudio);
window.addEventListener("mousedown", unlockAudio);
window.addEventListener("touchstart", unlockAudio);

function setPlaybackDirection(reverse) {
  if (!forwardBuffer || !reversedBuffer) return;
  if (playingReverse === reverse) return;
  playingReverse = reverse;
  if (sourceNode) sourceNode.disconnect();
  startAudio(reverse ? reversedBuffer : forwardBuffer);
}

/* ===== MAIN DRAW LOOP ===== */
function drawImageFitAspect(img){
  const imgAspect = img.width / img.height;
  let drawW, drawH;
  if(fitMode){
    if(imgAspect > TARGET_ASPECT){ drawH = h; drawW = h * TARGET_ASPECT; }
    else { drawW = w; drawH = w / TARGET_ASPECT; }
  } else {
    if(imgAspect > TARGET_ASPECT){ drawW = w; drawH = w / imgAspect; }
    else { drawH = h; drawW = h * imgAspect; }
  }
  ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
}

function drawOverlay(){
  overlay.textContent =
    `${fitMode? "FIT":"FILL"} | drift: ${(BASE_DRIFT+zoomSpeed).toFixed(3)} | audio x${baseAudioSpeed.toFixed(2)} ${playingReverse ? "(rev)" : ""}`;
}

function draw(){
  ctx.clearRect(0,0,w,h);
  if(!paused) zoom += BASE_DRIFT + zoomSpeed;
  zoomSpeed *= 0.9;
  const total = images.length;
  if(total===0) return;
  const zIndex = ((zoom % total)+total)%total;
  const i0 = Math.floor(zIndex);
  const i1 = (i0+1)%total;
  const t = zIndex - i0;
  const img0 = images[i0];
  const img1 = images[i1];
  const scale0 = Math.pow(SCALE_FACTOR, -t);
  const scale1 = Math.pow(SCALE_FACTOR, 1-t);

  ctx.save(); ctx.translate(w/2,h/2);
  ctx.scale(scale0,scale0); ctx.globalAlpha = 1 - t*0.5; drawImageFitAspect(img0); ctx.restore();
  ctx.save(); ctx.translate(w/2,h/2);
  ctx.scale(scale1,scale1); ctx.globalAlpha = t + 0.3; drawImageFitAspect(img1); ctx.restore();
  ctx.globalAlpha = 1;
  drawOverlay();

  if (sourceNode) {
    setPlaybackDirection(zoomSpeed < -0.02);
    sourceNode.playbackRate.value = Math.max(0.1, baseAudioSpeed * (1 + zoomSpeed));
  }
  requestAnimationFrame(draw);
}

function start(){ draw(); }

/* ===== FULLSCREEN BUTTON ===== */
document.getElementById("fullscreenBtn").addEventListener("click", () => {
  if (document.fullscreenElement) document.exitFullscreen();
  else document.body.requestFullscreen();
});
</script>
</body>
</html>

